---
title: "HW_02_14_2020"
author: "Min-Yao"
date: "2020/2/12"
output: 
  html_document: 
    keep_md: yes
---


```r
library(rethinking)
```

```
## Loading required package: rstan
```

```
## Loading required package: StanHeaders
```

```
## Loading required package: ggplot2
```

```
## rstan (Version 2.19.2, GitRev: 2e1f913d3ca3)
```

```
## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)
```

```
## For improved execution time, we recommend calling
## Sys.setenv(LOCAL_CPPFLAGS = '-march=native')
## although this causes Stan to throw an error on a few processors.
```

```
## Loading required package: parallel
```

```
## Loading required package: dagitty
```

```
## rethinking (Version 1.93)
```

```
## 
## Attaching package: 'rethinking'
```

```
## The following object is masked from 'package:stats':
## 
##     rstudent
```


### 1. Fit a simple model with effects of temperature difference (temperature_diff_fall) on November germination (nov_germ). Temperature difference is already centered and scaled (i.e., negative values are the smallest temperature differences). Make sure to use the appropriate likelihood for the germination data (0 = no germ, 1  = germ).


```r
clarkia <- read.csv("clarkia_transplant_data.csv")
head(clarkia)
```

```
##   temperature_diff_fall blk nov_germ pop    dam   sire nov_size mar_surv
## 1             1.1878937   1        0  AY   AY29   AY44       NA        0
## 2             1.1878937   3        1  AY   AY35   AY29        5        1
## 3             1.6650067   3        0  BB   BB44   BB37       NA        0
## 4             1.9434353   3        1  BC   BC54   BC37        1        1
## 5            -1.4869126   3        1  AR   AR37   AR46        1        0
## 6             0.6972648   4        1  AD AD71.3 AD75.1        1        0
##   mar_size fruit_count total_est_seeds temperature_diff_annual
## 1       NA           0               0               1.0756389
## 2        2           0               0               1.0756389
## 3       NA           0               0               1.5792800
## 4        6           0               0               1.8116999
## 5       NA           0               0              -0.6419634
## 6       NA           0               0               0.6501248
##   precip_diff_spring first_fl_julian last_fl_julian
## 1           22.53600              NA             NA
## 2           22.53600              NA             NA
## 3           12.02783              NA             NA
## 4           13.35525              NA             NA
## 5           28.62542              NA             NA
## 6            6.50400              NA             NA
```

```r
summary(clarkia)
```

```
##  temperature_diff_fall      blk           nov_germ         pop      
##  Min.   :-1.5923       Min.   :1.000   Min.   :0.00   BE     : 240  
##  1st Qu.:-1.0963       1st Qu.:2.000   1st Qu.:0.00   AD     : 236  
##  Median : 0.3377       Median :3.000   Median :1.00   AS     : 236  
##  Mean   : 0.1945       Mean   :2.505   Mean   :0.54   BN     : 235  
##  3rd Qu.: 1.5434       3rd Qu.:4.000   3rd Qu.:1.00   AQ     : 234  
##  Max.   : 1.9434       Max.   :4.000   Max.   :1.00   BB     : 232  
##                                                       (Other):1837  
##       dam            sire         nov_size        mar_surv     
##  AC03   :  16   BB02   :  32   Min.   :1.000   Min.   :0.0000  
##  AC05   :  16   BG50   :  24   1st Qu.:3.000   1st Qu.:0.0000  
##  AC08   :  16   AC03   :  16   Median :3.000   Median :0.0000  
##  AC17   :  16   AC13   :  16   Mean   :3.176   Mean   :0.2961  
##  AC18   :  16   AC15   :  16   3rd Qu.:4.000   3rd Qu.:1.0000  
##  AC21   :  16   AC17   :  16   Max.   :5.000   Max.   :1.0000  
##  (Other):3154   (Other):3130   NA's   :2249    NA's   :582     
##     mar_size       fruit_count      total_est_seeds    temperature_diff_annual
##  Min.   : 2.000   Min.   : 0.0000   Min.   :   0.000   Min.   :-1.4734        
##  1st Qu.: 6.000   1st Qu.: 0.0000   1st Qu.:   0.000   1st Qu.:-0.5820        
##  Median : 6.000   Median : 0.0000   Median :   0.000   Median : 0.2413        
##  Mean   : 7.317   Mean   : 0.2734   Mean   :   9.064   Mean   : 0.2957        
##  3rd Qu.:10.000   3rd Qu.: 0.0000   3rd Qu.:   0.000   3rd Qu.: 1.2411        
##  Max.   :18.000   Max.   :60.0000   Max.   :1794.000   Max.   : 1.8117        
##  NA's   :2477     NA's   :631       NA's   :631                               
##  precip_diff_spring first_fl_julian last_fl_julian 
##  Min.   : 0.8207    Min.   :149.0   Min.   :155.0  
##  1st Qu.:12.0278    1st Qu.:154.0   1st Qu.:159.0  
##  Median :18.5797    Median :159.0   Median :163.0  
##  Mean   :17.6746    Mean   :159.5   Mean   :168.5  
##  3rd Qu.:23.0091    3rd Qu.:161.0   3rd Qu.:176.0  
##  Max.   :31.9469    Max.   :181.0   Max.   :216.0  
##                     NA's   :3010    NA's   :3010
```

```r
str(clarkia)
```

```
## 'data.frame':	3250 obs. of  15 variables:
##  $ temperature_diff_fall  : num  1.19 1.19 1.67 1.94 -1.49 ...
##  $ blk                    : int  1 3 3 3 3 4 3 4 1 1 ...
##  $ nov_germ               : int  0 1 0 1 1 1 1 1 1 1 ...
##  $ pop                    : Factor w/ 15 levels "AC","AD","AQ",..: 7 7 9 10 4 2 1 8 14 15 ...
##  $ dam                    : Factor w/ 210 levels "AC03","AC05",..: 94 98 129 139 53 21 7 109 182 201 ...
##  $ sire                   : Factor w/ 208 levels "AC03","AC05",..: 99 93 125 136 55 23 14 101 180 203 ...
##  $ nov_size               : int  NA 5 NA 1 1 1 5 NA 4 4 ...
##  $ mar_surv               : int  0 1 0 1 0 0 1 1 1 1 ...
##  $ mar_size               : int  NA 2 NA 6 NA NA 10 6 6 6 ...
##  $ fruit_count            : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ total_est_seeds        : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ temperature_diff_annual: num  1.076 1.076 1.579 1.812 -0.642 ...
##  $ precip_diff_spring     : num  22.5 22.5 12 13.4 28.6 ...
##  $ first_fl_julian        : int  NA NA NA NA NA NA NA NA 181 NA ...
##  $ last_fl_julian         : int  NA NA NA NA NA NA NA NA 181 NA ...
```


```r
dat_list <- list(
    temperature_diff_fall = clarkia$temperature_diff_fall,
    nov_germ = clarkia$nov_germ)

summary(dat_list)
```

```
##                       Length Class  Mode   
## temperature_diff_fall 3250   -none- numeric
## nov_germ              3250   -none- numeric
```

```r
str(dat_list)
```

```
## List of 2
##  $ temperature_diff_fall: num [1:3250] 1.19 1.19 1.67 1.94 -1.49 ...
##  $ nov_germ             : int [1:3250] 0 1 0 1 1 1 1 1 1 1 ...
```


```r
set.seed(1)
modle_base <- ulam(
    alist(
        nov_germ ~ dbinom( 1 , p ) ,
        logit(p) <- a + bT*temperature_diff_fall,
        a ~ dnorm( 0 , 0.5 ),
        bT ~ dnorm( 0 , 1.5 )
    ) , data=dat_list , chains=4 , cores=4 , log_lik=TRUE )

precis( modle_base, depth=2 )
```

```
##          mean         sd       5.5%      94.5%    n_eff     Rhat
## a   0.2025639 0.03519197  0.1453126  0.2575232 1313.729 1.003083
## bT -0.2153452 0.02977729 -0.2622621 -0.1691057 1477.630 1.001394
```

```r
plot( precis(modle_base,depth=2) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-4-1.png)<!-- -->


### 2. Simulate from your priors to see if you've chosen reasonable priors, adjust them if necessary.

#### These blocks were set up in the field, and had differences in soil depth, slope, and competitive environment. So maybe a model that includes block will describe the data better.


```r
#from R code 5.4
set.seed(1)
prior <- extract.prior( modle_base )
```

```
## 
## SAMPLING FOR MODEL 'fcecba548d444f4f212f426afc07aa7e' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.407 seconds (Warm-up)
## Chain 1:                2.373 seconds (Sampling)
## Chain 1:                4.78 seconds (Total)
## Chain 1:
```

```r
str(prior)
```

```
## List of 2
##  $ a : num [1:1000(1d)] -0.3397 -0.7038 -0.5996 0.0733 -0.2349 ...
##  $ bT: num [1:1000(1d)] -1.321 2.906 0.849 -1.015 -1.038 ...
##  - attr(*, "source")= chr "ulam prior: 1000 samples from fit"
```

```r
mu <- link( modle_base , post=prior , data=list( temperature_diff_fall=c(-2,2) ) )

plot( NULL , xlim=c(-2,2) , ylim=c(0,1) )
for ( i in 1:100 ) lines( c(-2,2) , mu[i,] , col=col.alpha("black",0.4) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-5-1.png)<!-- -->

#### Try a smaller prior


```r
set.seed(1)
modle_base_s <- ulam(
    alist(
        nov_germ ~ dbinom( 1 , p ) ,
        logit(p) <- a + bT*temperature_diff_fall,
        a ~ dnorm( 0 , 0.2 ),
        bT ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , cores=4 , log_lik=TRUE )

precis( modle_base_s, depth=2 )
```

```
##          mean        sd       5.5%      94.5%    n_eff      Rhat
## a   0.1992770 0.0359537  0.1428361  0.2571375 1299.362 0.9998886
## bT -0.2135348 0.0300941 -0.2615507 -0.1661229 1188.556 1.0004099
```

```r
plot( precis(modle_base_s,depth=2) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-6-1.png)<!-- -->


```r
#from R code 5.4
set.seed(1)
prior <- extract.prior( modle_base_s )
```

```
## 
## SAMPLING FOR MODEL 'ec6b5ab37f26cf3df0888fa27c9f4c91' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.001 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 10 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.725 seconds (Warm-up)
## Chain 1:                2.384 seconds (Sampling)
## Chain 1:                5.109 seconds (Total)
## Chain 1:
```

```r
str(prior)
```

```
## List of 2
##  $ a : num [1:1000(1d)] 0.137 -0.573 -0.145 -0.273 0.085 ...
##  $ bT: num [1:1000(1d)] -0.0747 0.3319 0.7763 -0.2841 0.4869 ...
##  - attr(*, "source")= chr "ulam prior: 1000 samples from fit"
```

```r
mu <- link( modle_base_s , post=prior , data=list( temperature_diff_fall=c(-2,2) ) )

plot( NULL , xlim=c(-2,2) , ylim=c(0,1) )
for ( i in 1:100 ) lines( c(-2,2) , mu[i,] , col=col.alpha("black",0.4) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-7-1.png)<!-- -->

#### Try a larger prior


```r
set.seed(1)
modle_base_l <- ulam(
    alist(
        nov_germ ~ dbinom( 1 , p ) ,
        logit(p) <- a + bT*temperature_diff_fall,
        a ~ dnorm( 0 , 10 ),
        bT ~ dnorm( 0 , 20 )
    ) , data=dat_list , chains=4 , cores=4 , log_lik=TRUE )

precis( modle_base_l, depth=2 )
```

```
##          mean         sd       5.5%      94.5%     n_eff     Rhat
## a   0.2043821 0.03476612  0.1493003  0.2615614 1363.2987 1.001280
## bT -0.2147017 0.03028697 -0.2625627 -0.1664489  949.6129 1.004178
```

```r
plot( precis(modle_base_l,depth=2) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-8-1.png)<!-- -->


```r
#from R code 5.4
set.seed(1)
prior <- extract.prior( modle_base_l )
```

```
## 
## SAMPLING FOR MODEL '484b13bcefe3679bfe048af1af1e5237' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.36 seconds (Warm-up)
## Chain 1:                2.017 seconds (Sampling)
## Chain 1:                4.377 seconds (Total)
## Chain 1:
```

```r
str(prior)
```

```
## List of 2
##  $ a : num [1:1000(1d)] -9.96 -6.26 -3.95 -6.41 2.38 ...
##  $ bT: num [1:1000(1d)] -19.05226 -0.00849 16.67019 -33.87567 30.58286 ...
##  - attr(*, "source")= chr "ulam prior: 1000 samples from fit"
```

```r
mu <- link( modle_base_l , post=prior , data=list( temperature_diff_fall=c(-2,2) ) )

plot( NULL , xlim=c(-2,2) , ylim=c(0,1) )
for ( i in 1:100 ) lines( c(-2,2) , mu[i,] , col=col.alpha("black",0.4) )
```

![](HW_02_14_2020_files/figure-html/unnamed-chunk-9-1.png)<!-- -->

### 3. Fit a model that includes an effect of block (blk), with no pooling.




### 4. Fit a model that includes block, and allows partial pooling.

#### The experiment included many individuals from each of the 15 populations. So, each individual is not an independent representative of a given temperature, but might be similar to other plants from that population for reasons besides temperature.




### 5. Build a model that accounts for this by including population (pop) and allowing partial pooling between populations A) without block, and B) with block included as in the model above. How does including population affect the temperature estimate?



### 6. Compare the five models you built using WAIC. Which fits best?



### 7. Plot effects of temperature difference for the average block, and also make a plot that includes the variability across blocks.



